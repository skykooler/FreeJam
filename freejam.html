<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        .main {
            display: grid;
            width: 100%;
            height: 100%;
            position: absolute;
            grid-template-columns: 1fr;
            grid-template-rows: 100px 1fr 100px;
            grid-column-gap: 0px;
            grid-row-gap: 0px;
        }

        .header {
            grid-area: 1 / 1 / 2 / 2;
            background-color: #aaa;
        }
        .tracks {
            grid-area: 2 / 1 / 3 / 2;
            overflow-y: auto;
        }
        .controls { 
            grid-area: 3 / 1 / 4 / 2; 
            background-color: #aaa;
        }
        .tracks {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: 30px 1fr;
            grid-column-gap: 0px;
            grid-row-gap: 0px;
        }
        .headersheader {
            grid-area: 1 / 1 / 2 / 2;
            background-color: aquamarine;
        }
        .rollsheader {
            height: 30px;
            width: auto;
            background-color: green;
            position: relative;
        }
        cursortop {
            height: 100%;
            width: 10px;
            margin-left: -5px;
            position: absolute;
            background-color: black;
            z-index: 2;
        }

        .trackheaders {
            grid-area: 2 / 1 / 3 / 2;
            background-color: cyan;
        }
        .trackrolls {
            grid-area: 1 / 2 / 3 / 3;
            overflow-x: auto;
            position: relative;
        }
        .trackrollwrapper {
            min-width: 100%;
            min-height:100%;
            position: relative;
            background-size: 100px;
            background-image:  repeating-linear-gradient(to right, #444cf7, #444cf7 1px, #e5e5f7 1px, #e5e5f7);
        }
        .trackheader {
            width: 100%;
            height: 100px;
            box-sizing: border-box;
            border-top: 3px solid white;
            border-bottom: 3px solid black;
            background-color:blueviolet;
        }
        .trackheader.active {
            background-color:chocolate;
        }
        .track {
            box-sizing: border-box;
            border-bottom: 1px solid black;
            min-width: 100%;
            height: 100px;
            position: relative;
        }
        .trackroll {
            height: 100px;
            width: 10px; /* TODO */
            position: absolute;
        }
        cursor {
            height: 100%;
            width:0;
            position: absolute;
            border-left: 1px solid red;
            z-index: 1;
        }
    </style>
<script src="webaudio/tone.js"></script>
</head>
<body>
    <div class="main">
        <div class="header"></div>
        <div class="tracks">
            <div class="headersheader"></div>
            <div class="trackheaders">
                <div class="trackheader"></div>
                <div class="trackheader active"></div>
                <div class="trackheader"></div>
            </div>
            <div class="trackrolls">
                <div class="trackrollwrapper">
                    <cursor></cursor>
                    <div class="rollsheader">
                        <cursortop></cursortop>
                    </div>
                    <div class="track"></div>
                    <div class="track">
                        <canvas class="trackroll" width="10000px" height="100px"></canvas>
                    </div>
                    <div class="track"></div>
                </div>

            </div>
        </div>
        <div class="controls">
            <button class="record">Record</button>
            <button class="play">Play</button>
            <button class="stop">Stop</button>
        </div>
    </div>
<script>
// jQuery in 50 bytes, booya
function $(x) { return document.querySelector(x) }

tracks = []
class Instrument {
    constructor (name, type, samples, filters) {
        this.name = name
        this.type = type
        this.active_key = undefined
        this.active_notes = new Set()
        // Possible types include synth, polysynth, sampled, and recorded
        if (type=="synth") {
            this.synth = new Tone.Synth().toDestination()
        } else if (type=="polysynth") {
            this.synth = new Tone.PolySynth(Tone.Synth).toDestination()
        } else if (type=="sampled") {
            this.sampler = new Tone.Sampler({
                urls: samples,
                release: 1, // TODO: don't hardcode this
                baseUrl: "instruments/keyboards/piano2/", // TODO: don't hardcode this either
            }).toDestination()
            Tone.loaded().then(() => {
                this.loaded = true
            })
        }
    }
    play_note(note, duration) {
        if (this.type == "synth" || this.type == "polysynth") {
            if (duration) {
                this.synth.triggerAttackRelease(note, duration)
            } else {
                this.synth.triggerAttack(note)
                this.active_key = note
                if (this.type=="synth") {
                    this.active_notes.clear()
                }
                this.active_notes.add(note)
                console.log(this.active_notes)
            }
        } else if (this.type == "sampled" && this.loaded) {
            if (duration) {
                this.sampler.triggerAttackRelease(note, duration)
            } else {
                this.sampler.triggerAttack(note)
                this.active_notes.add(note)
            }
        }
    }
    release_note(note) {
        if (this.type == "synth") {
            if (this.active_key == note) {
                this.synth.triggerRelease()
                this.active_key = undefined
                this.active_notes.clear()
            }
        } else if (this.type == "polysynth") {
            this.synth.triggerRelease(note)
            this.active_notes.delete(note)
        } else if (this.type == "sampled") {
            this.sampler.triggerRelease(note)
            this.active_notes.delete(note)
        }
    }
    release_all() {
        if (this.type == 'synth') {
            this.synth.triggerRelease()
        } else if (this.type == 'polysynth') {
            this.synth.releaseAll()
        } else if (this.type == "sampled") {
            this.sampler.releaseAll()
        }
    }
}
class Track {
    constructor (name, instrument) {
        this.name = name
        this.instrument = instrument
        this.trackheader = document.createElement('div')
        this.trackheader.className = 'trackheader'
        this.trackheader.innerHTML = `
            <div class="logo"></div>
            <div class="track_name">`+this.name+`</div>
            <div class="track_controls">
                <button class="toggle_mute">Toggle Mute</button>
                <button class="toggle_solo">Toggle Solo</button>
                <input type="range" min="0" max="1.5" value="1" step="0.01" />
            </div>`
        $('.trackheaders')?.appendChild(this.trackheader)
        this.track = document.createElement('div')
        this.track.className = 'track'
        $('.trackrollwrapper')?.appendChild(this.track)
        tracks.push(this)
        this.buffers = []
        this.activeBuffer = undefined
        this.active_notes = {}
    }
    play_note(note) {
        var ref;
        var rec;
        this.instrument.play_note(note)
        if (recording) {
            ref = 1
            rec = [Tone.Transport.seconds, ref, note]
            this.activeBuffer?.push(rec)
            this.active_notes[note] = rec
        }
    }
    release_note(note) {
        var ref;
        if (recording) {
            if (note in this.active_notes) {
                this.active_notes[note][3] = Tone.Transport.seconds - this.active_notes[note][0]
            }
        }
        this.instrument.release_note(note)
    }
    release_all() {
        var ref;
        if (recording) {
            for (let note of this.instrument.active_notes) {
                this.active_notes[note][3] = Tone.Transport.seconds - this.active_notes[note][0]
            }
        }
        this.instrument.release_all()
    }
    startRecording() {
        var buf = []
        var canvas = document.createElement('canvas')
        canvas.width = 10
        canvas.height = 100
        canvas.className = "trackroll"
        canvas.draggable = true
        this.track.appendChild(canvas)
        canvas.style.left = Tone.Transport.seconds * xScalingFactor + "px"
        active_canvas = canvas
        this.buffers.push({
            buffer: buf,
            start: Tone.Transport.seconds,
            canvas: canvas
        })
        this.activeBuffer = buf
    }
    stopRecording() {
        if (this.activeBuffer && recording) {
            var pos = Tone.Transport.position
            for (let note of this.activeBuffer) {
                note[1] = Tone.Transport.schedule((time) => { this.instrument.play_note(note[2], note[3])}, note[0])
            }
            this.activeBuffer = undefined
        }
    }
}
keysMapLayouts = {
    us: {
        KeyA:"C",
        KeyW:"C#",
        KeyS:"D",
        KeyE:"Eb",
        KeyD:"E",
        KeyF:"F",
        KeyT:"F#",
        KeyG:"G",
        KeyY:"Ab",
        KeyH:"A",
        KeyU:"Bb",
        KeyJ:"B",
        KeyK:"C^",
        KeyO:"C#^^",
        KeyL:"D^",
        KeyP:"Eb^",
        Semicolon:"E^",
        Quote:"F^",
        KeyZ: "-",
        KeyX: "+",
        KeyR: "Record",
        Space: "Play",
        Escape: "Stop",
    }
}
keysMap = keysMapLayouts.us
octave = 4
active_track = undefined
active_keys = new Set()
active_canvas = undefined
recording = false
notePosition = {}
autoscroll = false
lastDrawPos = 0
noteNames = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B']
xScalingFactor = 100
yScalingFactor = 100
for (let i in noteNames) {
    for (let j of [1,2,3,4,5,6,7,8]) {
        notePosition[noteNames[i]+j] = 1 - (i/24 + j%2/2) - 1/24
    }
}

//attach a click listener to a play button
$('body')?.addEventListener('click', async () => {
    if (Tone.context.state === "suspended") {
        await Tone.start()
    }
})

//Virtual Keyboard event handlers
$('body')?.addEventListener('keydown', async (e) => {
    if (Tone.context.state === "suspended") {
        await Tone.start()
    }
    if (active_keys.has(e.code)) return;
    active_keys.add(e.code)
    note_base = keysMap[e.code]
    if (note_base) {
        if ('-+PlayRecordStop'.indexOf(note_base)!=-1) {
            if (note_base=='-' && octave > 1) {
                octave--;
            } else if (note_base=='+' && octave < 7) {
                octave++;
            } else if (note_base == "Play") {
                playPause()
            } else if (note_base == "Record") {
                record()
            } else if (note_base == "Stop") {
                stop()
            }
            return
        }
        note_array = note_base.split("^")
        note = note_array[0]
        if (note_array.length>1) {
            note = note + (octave+1)
        } else {
            note = note + octave
        }
        active_track.play_note(note)
    }
})
$('body')?.addEventListener('keyup', async (e) => {
    active_keys.delete(e.code)
    note_base = keysMap[e.code]
    if (note_base) {
        if ('-+PlayRecordStop'.indexOf(note_base)!=-1) {
            return;
        }
        note_array = note_base.split("^")
        note = note_array[0]
        if (note_array.length>1) {
            note = note + (octave+1)
        } else {
            note = note + octave
        }
        active_track.release_note(note)
    }
})

function playPause() {
    if (Tone.Transport.state == 'started') {
        active_track.release_all()
        active_track.stopRecording()
        Tone.Transport.pause()
        recording = false
        $('button.play').innerText = "Play"
    } else {
        Tone.Transport.start()
        $('button.play').innerText = "Pause"
        autoscroll = true
    }
}
function stop() {
    active_track.release_all()
    active_track.stopRecording()
    recording = false
    Tone.Transport.stop()
    lastDrawPos = 0
    $('button.play').innerText = "Play"
}
function record() {
    recording = !recording
    if (recording) {
        Tone.Transport.start()
        active_track.startRecording()
        autoscroll = true
    } else {
        active_track.stopRecording()
    }
    console.log("Recording: ", recording)
}

// Playback control event handlers
$('button.record')?.addEventListener('click', async () => {
    record()
})
$('button.stop')?.addEventListener('click', async () => {
    stop()
})
$('button.play')?.addEventListener('click', async () => {
    playPause()
})

function drawActiveTrack() {
    offset = active_canvas ? parseInt(active_canvas.style.left) : 0
    x = parseInt(Tone.Transport.seconds * xScalingFactor) - offset
    delta = x-lastDrawPos
    width = Math.max(10, x)
    if(recording) {
        ctx = active_canvas?.getContext("2d")
        if (width > active_canvas.width) {
            active_canvas.width += 100
            active_canvas.style.width = active_canvas.width+"px"

            ctx.fillStyle="rgba(200,200,200,1)"
            ctx.lineStyle="none"
            ctx.fillRect(0,0, width, yScalingFactor)
            ctx.fillStyle = "rgba(0,0,0,1)"
            for (let note of active_track.activeBuffer) {
                pos = notePosition[note[2]] * yScalingFactor // TODO: scaling
                ctx.fillRect(note[0] * xScalingFactor - offset, pos, note[3]*xScalingFactor||(x-note[0]*xScalingFactor + offset), 4)
            }
        }
        ctx.fillStyle="rgba(200,200,200,1)"
        ctx.lineStyle="none"
        ctx.fillRect(lastDrawPos,0,delta,yScalingFactor)
        ctx.fillStyle = "rgba(0,0,0,1)"
        for (let i of active_track.instrument.active_notes) {
            pos = notePosition[i] * yScalingFactor // TODO: unhardcode scaling
            ctx.fillRect(lastDrawPos,pos,delta,4)
        }
    }
    $('.trackrollwrapper').style.width = Math.max($('.trackrollwrapper').offsetWidth, x + offset + 200) + "px"
    $('cursortop').style.left = x + offset + 'px'
    $('cursor').style.left = x + offset + 'px'
    if (autoscroll) {
        $("cursor").scrollIntoView({
            behavior: 'smooth',
            block: 'nearest',
            inline: 'center'
        })
        // $("cursortop").scrollIntoView({
        //     behavior: 'smooth',
        //     block: 'nearest',
        //     inline: 'center'
        // })
    }
    lastDrawPos = x
    requestAnimationFrame(drawActiveTrack)
}

// Timeline event handlers
function manualScrollNotify (e) {
    autoscroll = false
}
$('.trackrolls').addEventListener('wheel', manualScrollNotify)
$('.trackrolls').addEventListener('touchmove', manualScrollNotify)
$('.trackrolls').addEventListener('mousedown', manualScrollNotify)


// temporary hardcoded initialization
instrument = new Instrument('foo', 'sampled', {C4:"C4.mp3", A4: "A4.mp3", C5: "C5.mp3"})
active_track = new Track("Piano2", instrument)
// active_canvas = $('canvas.trackroll')

drawActiveTrack()
</script>
</body>
</html>