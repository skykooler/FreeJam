<!DOCTYPE html>
<html>
<head>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
        .main {
            display: grid;
            width: 100%;
            height: 100%;
            position: absolute;
            grid-template-columns: 1fr;
            grid-template-rows: 100px 1fr 100px;
            grid-column-gap: 0px;
            grid-row-gap: 0px;
        }

        .header {
            grid-area: 1 / 1 / 2 / 2;
            background-color: #aaa;
        }
        .tracks {
            grid-area: 2 / 1 / 3 / 2;
            overflow-y: auto;
        }
        .controls { 
            grid-area: 3 / 1 / 4 / 2; 
            background-color: #aaa;
        }
        .tracks {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: 1fr;
            grid-column-gap: 0px;
            grid-row-gap: 0px;
        }

        .trackheaders {
            grid-area: 1 / 1 / 2 / 2;
            background-color: cyan;
        }
        .trackrolls {
            grid-area: 1 / 2 / 2 / 3;
            overflow-x: auto;
            position: relative;
        }
        .trackheader {
            width: 100%;
            height: 100px;
            box-sizing: border-box;
            border-top: 3px solid white;
            border-bottom: 3px solid black;
            background-color:blueviolet;
        }
        .trackheader.active {
            background-color:chocolate;
        }
        .track {
            box-sizing: border-box;
            border-bottom: 1px solid black;
            min-width: 100%;
            height: 100px;
            position: relative;
        }
        .trackroll {
            height: 100px;
            width: 10000px; /* TODO */
            position: absolute;
        }
        .cursor {
            height: 100%;
            width:0;
            position: absolute;
            border-left: 1px solid red;
        }
    </style>
<script src="webaudio/tone.js"></script>
</head>
<body>
    <div class="main">
        <div class="header"></div>
        <div class="tracks">
            <div class="trackheaders">
                <div class="trackheader"></div>
                <div class="trackheader active"></div>
                <div class="trackheader"></div>
            </div>
            <div class="trackrolls">
                <div class="cursor"></div>
                <div class="track"></div>
                <div class="track">
                    <canvas class="trackroll" width="10000px" height="100px"></canvas>
                </div>
                <div class="track"></div>

            </div>
        </div>
        <div class="controls">
            <button class="record">Record</button>
            <button class="play">Play</button>
            <button class="stop">Stop</button>
        </div>
    </div>
<script>
tracks = []
class Instrument {
    constructor (name, type, samples, filters) {
        this.name = name
        this.type = type
        this.active_key = undefined
        this.active_notes = new Set()
        // Possible types include synth, polysynth, sampled, and recorded
        if (type=="synth") {
            this.synth = new Tone.Synth().toDestination()
        } else if (type=="polysynth") {
            this.synth = new Tone.PolySynth(Tone.Synth).toDestination()
        } else if (type=="sampled") {
            this.sampler = new Tone.Sampler({
                urls: samples,
                release: 1, // TODO: don't hardcode this
                baseUrl: "instruments/keyboards/piano2/", // TODO: don't hardcode this either
            }).toDestination()
            Tone.loaded().then(() => {
                this.loaded = true
            })
        }
    }
    play_note(note) {
        if (this.type == "synth" || this.type == "polysynth") {
            this.synth.triggerAttack(note)
            this.active_key = note
            if (this.type=="synth") {
                this.active_notes.clear()
            }
            this.active_notes.add(note)
            console.log(this.active_notes)
        } else if (this.type == "sampled" && this.loaded) {
            this.sampler.triggerAttack(note)
            this.active_notes.add(note)
        }
    }
    release_note(note) {
        if (this.type == "synth") {
            if (this.active_key == note) {
                this.synth.triggerRelease()
                this.active_key = undefined
                this.active_notes.clear()
            }
        } else if (this.type == "polysynth") {
            this.synth.triggerRelease(note)
            this.active_notes.delete(note)
        } else if (this.type == "sampled") {
            this.sampler.triggerRelease(note)
            this.active_notes.delete(note)
        }
    }
    release_all() {
        if (this.type == 'synth') {
            this.synth.triggerRelease()
        } else if (this.type == 'polysynth') {
            this.synth.releaseAll()
        } else if (this.type == "sampled") {
            this.sampler.releaseAll()
        }
    }
}
class Track {
    constructor (name, instrument) {
        this.name = name
        this.instrument = instrument
        this.trackheader = document.createElement('div')
        this.trackheader.className = 'trackheader'
        this.trackheader.innerHTML = `
            <div class="logo"></div>
            <div class="track_name">`+this.name+`</div>
            <div class="track_controls">
                <button class="toggle_mute">Toggle Mute</button>
                <button class="toggle_solo">Toggle Solo</button>
                <input type="range" min="0" max="1.5" value="1" />
            </div>`
        document.querySelector('.trackheaders')?.appendChild(this.trackheader)
        this.track = document.createElement('div')
        this.track.className = 'track'
        document.querySelector('.trackrolls')?.appendChild(this.track)
        tracks.push(this)
        this.buffers = []
        this.activeBuffer = undefined
    }
    play_note(note) {
        var ref;
        if (recording) {
            ref = Tone.Transport.schedule((time) => { this.instrument.play_note(note); }, Tone.Transport.position)
            this.activeBuffer?.push([Tone.Transport.seconds, ref, note, 'attack'])
        } else {
            this.instrument.play_note(note)
        }
    }
    release_note(note) {
        var ref;
        if (recording) {
            ref = Tone.Transport.schedule((time) => { this.instrument.release_note(note); }, Tone.Transport.position)
            this.activeBuffer?.push([Tone.Transport.seconds, ref, note, 'release'])
        } else {
            this.instrument.release_note(note)
        }
    }
    release_all() {
        var ref;
        if (recording) {
            ref = Tone.Transport.schedule((time) => { this.instrument.release_all(); }, Tone.Transport.position)
            for (let note of this.instrument.active_notes) {
                this.activeBuffer?.push([Tone.Transport.seconds, ref, note, 'release'])
            }
        } else {
            this.instrument.release_all()
        }
    }
    startRecording() {
        var buf = []
        this.buffers.push(buf)
        this.activeBuffer = buf
    }
}
keysMapLayouts = {
    us: {
        KeyA:"C",
        KeyW:"C#",
        KeyS:"D",
        KeyE:"Eb",
        KeyD:"E",
        KeyF:"F",
        KeyT:"F#",
        KeyG:"G",
        KeyY:"Ab",
        KeyH:"A",
        KeyU:"Bb",
        KeyJ:"B",
        KeyK:"C^",
        KeyO:"C#^^",
        KeyL:"D^",
        KeyP:"Eb^",
        Semicolon:"E^",
        Quote:"F^",
        KeyZ: "-",
        KeyX: "+",
        KeyR: "Record",
        Space: "Play",
        Escape: "Stop",
    }
}
keysMap = keysMapLayouts.us
octave = 4
active_track = undefined
active_keys = new Set()
recording = false
notePosition = {}
lastDrawPos = 0
noteNames = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B']
for (let i in noteNames) {
    for (let j of [1,2,3,4,5,6,7,8]) {
        notePosition[noteNames[i]+j] = 1 - (i/24 + j%2/2) - 1/24
    }
}

//attach a click listener to a play button
document.querySelector('body')?.addEventListener('click', async () => {
    if (Tone.context.state === "suspended") {
        await Tone.start()
    }
})

//Virtual Keyboard event handlers
document.querySelector('body')?.addEventListener('keydown', async (e) => {
    if (Tone.context.state === "suspended") {
        await Tone.start()
    }
    if (active_keys.has(e.code)) return;
    active_keys.add(e.code)
    note_base = keysMap[e.code]
    if (note_base) {
        if ('-+PlayRecordStop'.indexOf(note_base)!=-1) {
            if (note_base=='-' && octave > 1) {
                octave--;
            } else if (note_base=='+' && octave < 7) {
                octave++;
            } else if (note_base == "Play") {
                playPause()
            } else if (note_base == "Record") {
                record()
            } else if (note_base == "Stop") {
                stop()
            }
            return
        }
        note_array = note_base.split("^")
        note = note_array[0]
        if (note_array.length>1) {
            note = note + (octave+1)
        } else {
            note = note + octave
        }
        // if (recording) {
        //     var _note=note
        //     var _active_track=active_track
        //     Tone.Transport.schedule((time) => { _active_track.play_note(_note); }, Tone.Transport.position)
        // } else {
            active_track.play_note(note)
        // }
    }
})
document.querySelector('body')?.addEventListener('keyup', async (e) => {
    active_keys.delete(e.code)
    note_base = keysMap[e.code]
    if (note_base) {
        if ('-+PlayRecordStop'.indexOf(note_base)!=-1) {
            return;
        }
        note_array = note_base.split("^")
        note = note_array[0]
        if (note_array.length>1) {
            note = note + (octave+1)
        } else {
            note = note + octave
        }
        // if (recording) {
        //     var _note=note
        //     var _active_track=active_track
        //     Tone.Transport.schedule((time) => { _active_track.release_note(_note); }, Tone.Transport.position)
        // } else {
            active_track.release_note(note)
        // }
    }
})

function playPause() {
    if (Tone.Transport.state == 'started') {
        active_track.release_all()
        Tone.Transport.pause()
        recording = false
        document.querySelector('button.play').innerText = "Play"
    } else {
        Tone.Transport.start()
        document.querySelector('button.play').innerText = "Pause"
    }
}
function stop() {
    active_track.release_all()
    recording = false
    Tone.Transport.stop()
    lastDrawPos = 0
    document.querySelector('button.play').innerText = "Play"
}
function record() {
    recording = !recording
    if (recording) {
        Tone.Transport.start()
        active_track.startRecording()
    } else {
        active_track.stopRecording()
    }
    console.log("Recording: ", recording)
}

// Playback control event handlers
document.querySelector('button.record')?.addEventListener('click', async () => {
    record()
})
document.querySelector('button.stop')?.addEventListener('click', async () => {
    stop()
})
document.querySelector('button.play')?.addEventListener('click', async () => {
    playPause()
})

function drawActiveTrack() {
    x = parseInt(Tone.Transport.seconds * 100)
    delta = x-lastDrawPos
    ctx = active_canvas.getContext("2d")
    if(recording) {
        ctx.fillStyle="rgba(200,200,200,1)"
        ctx.lineStyle="none"
        ctx.fillRect(lastDrawPos,0,delta,100)
        ctx.fillStyle = "rgba(0,0,0,1)"
        for (let i of active_track.instrument.active_notes) {
            pos = notePosition[i] * 100 // TODO: unhardcode scaling
            ctx.fillRect(lastDrawPos,pos,delta,4)
        }
    }
    document.querySelector('.cursor').style.left = x + 'px'
    lastDrawPos = x
    requestAnimationFrame(drawActiveTrack)
}


// temporary hardcoded initialization
instrument = new Instrument('foo', 'sampled', {C4:"C4.mp3", A4: "A4.mp3", C5: "C5.mp3"})
active_track = new Track("Piano2", instrument)
active_canvas = document.querySelector('canvas.trackroll')

drawActiveTrack()
</script>
</body>
</html>